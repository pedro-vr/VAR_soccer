---
title: "VAR in PL"
author: "Pedro Alan Velázquez Romero"
date: "5/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
#librerias a utilizar 
#install.packages(c("dplyr","ggplot2","tidyr","httr","XML","rvest","xml2","tidyverse","robotstxt",
            #       "urltools"))
library(dplyr)
library(ggplot2)
library(tidyr)
library(httr)
library(XML)
library(rvest)
library(xml2)
library(tidyverse)
library(robotstxt)
library(urltools)
library(XML)
library(methods)
```

Esta es la primera versión del documento en donde se harán los cálculos para el análisis del VAR en el fútbol. A partir de aquí se va a empezar con un análisis descriptivo de los datos, además de reconocer los datos verdaderamente valiosos con los que se trabajará.

El primer acercamiento por supuesto es sobre el VAR como nueva medida en el fútbol, de aquí que sale el repentino interés de querer saber lo siguiente:

1. En qué fecha se implementó el VAR? A partir de ahí podemos hacer comparaciones entre métricas de equipos antes y después del VAR
2. Si se puede conseguir datos del VAR en la PL entonces también podemos comparar el efecto del VAR junto al efecto que trajo consigo la pandemia del COVID-19.

Implementación del VAR en la PL: **2018 empieza como piloto, se implementó en 2019 de manera oficial**

Propuestas de métricas para medir la ineficiencia/eficiencia del VAR (Arturo Brizio, presidente de la Comisión de Árbitros en México):

1. La unificación de procedimientos
2. La línea de intervención (equilibrio entre poco y nunca, solamente when necessary)
3. Tiempo de revisión (el promedio hasta marzo 2021 es de 1.5 mins, el máximo es 9 mins)
4. Medidas PEGII: Penal, Expulsión, Gol, Identidad errónea e Incidente no visto por el árbitro

Esta criteria trasladada en la PL varia un poco debido a que en esa liga se toman en cuenta más variables, la referencia de esto es el siguiente link proveniente de la página oficial de la PL: https://www.premierleague.com/news/1293321

Fuente: https://www.marca.com/claro-mx/futbol/liga-mx/2021/03/25/605cfb42ca4741d5138b4612.html

VAR definición: https://www.marca.com/claro-mx/futbol/liga-mx/2018/10/18/5bc8a11a268e3ebb268b45ce.html


Si obtenemos el documento directamente de la página de GitHub de FiveThirtyEight se tienen los partidos actualizados al día.

```{r}
#al parecer aquí ya se encuentran desde 2016 hasta hoy, se actualiza cada semana
url <- "https://projects.fivethirtyeight.com/soccer-api/club/spi_matches.csv"
football_matches <- read.csv(url,fileEncoding = 'UTF-8',skipNul = T)
premier_league <- filter(football_matches,league == "Barclays Premier League")
```

En el caso de la PL, como se trata de torneos largos, aquí no se mete la variable de una "liguilla" a comparación con la liga de México. Aquí se toman en cuenta todos los partidos y lo que cambian son los ascendidos y descendidos en cada temporada.

Aquí se considerarán dos nuevas variables, a saber, las siguientes:

- after_covid: flag que denota si el partido se jugó en pandemia o pre-pandemia. La PL se suspendió un 13 de marzo de 2020 según ESPN
- is_VAR: flag que denota si en el partido ya está implemnentado el VAR o no. EL VAR se implementó en la PL a partir de la temporada 19/20, es decir, a partir del 9 de agosto de 2019.

```{r,include=FALSE}
#Creamos otra variable para determinar en qué momento inició COVID
premier_league <- premier_league %>% mutate(after_covid = if_else(as.POSIXct(date) > as.POSIXct('2020-03-13'),1,0))
#Creamos la variable que nos indica si en el partido estuvo presente el VAR
premier_league <- premier_league %>% mutate(is_VAR = if_else(as.POSIXct(date) > as.POSIXct('2019-08-08'),1,0))
```

```{r,include=FALSE}
head(premier_league,3)
arrange(premier_league,desc(date))
arrange(premier_league,date)
```

```{r}
head(premier_league,3)
```

Se cuenta con un archivo en donde se denotan las intervenciones del VAR en la PL de la temporada 19/20 (la primera temporada en que se implementó) y se va a hacer un data set de esos records a continuación.

```{r,include=FALSE}
#Empezamos el proceso para obtener los datos de las intervenciones del VAR en temporadas 19/20 y 20/21 de la PL

#Leemos primero todo el archivo html de la temporada 19/20
VAR_19_20 <- htmlParse("/Users/pedrovela/Documentos/Git_repos/VAR_soccer/VAR_in_PL_19-20.html")
#Leemos primero todo el archivo html de la temporada 20/21
VAR_20_21 <- htmlParse("/Users/pedrovela/Documentos/Git_repos/VAR_soccer/VAR_in_PL_20-21.html")

#Nos traemos las tablas de overturns del VAR hacia todos los equipos para la 19/20, los cuales sabemos que están en los nodos de la forma <aside class = "inline editorial float-r">
var_overturns_19_20 <- getNodeSet(VAR_19_20, "//aside[@class='inline editorial float-r']") %>% sapply(., xmlValue)
#Nos traemos las tablas de overturns del VAR hacia todos los equipos para la 20/21, los cuales sabemos que están en los nodos de la forma <aside class = "inline editorial float-r">
var_overturns_20_21 <- getNodeSet(VAR_20_21, "//aside[@class='inline editorial float-r']") %>% sapply(., xmlValue)

#Nos traemos los nombres de los equipos de la PL de la 19/20 con sus puntos a favor o en contra a raíz de decisiones del VAR (netscore), los cuales sabemos que están en nodos de la forma <h2>
teams_19_20 <- getNodeSet(VAR_19_20, "//h2") %>% sapply(., xmlValue)
#Nos traemos los nombres de los equipos de la PL de la 20/21 con sus puntos a favor o en contra a raíz de decisiones del VAR (netscore), los cuales sabemos que están en nodos de la forma <h2>
teams_20_21 <- getNodeSet(VAR_20_21, "//h2") %>% sapply(., xmlValue)

#Nos traemos el detalle de las decisiones del VAR por cada equipo de la 19/20, los cuales sabemos que están en nodos del tipo <p>
details_var_19_20 <- getNodeSet(VAR_19_20, "//p") %>% sapply(., xmlValue)
#Nos traemos el detalle de las decisiones del VAR por cada equipo de la 20/21, los cuales sabemos que están en nodos del tipo <p>
details_var_20_21 <- getNodeSet(VAR_20_21, "//p") %>% sapply(., xmlValue)

#Empezamos a tratar con los datos obtenidos arriba para solo quedarnos con la info importante

#Se va a guardar todos los datos "servibles" o "útiles" dentro de un solo array
ovrt_19_20 <- NULL
#Vamos a hacer un loop para guardar los datos acerca de los overturns de los equipos de la 19/20
for (a in 1:length(var_overturns_19_20)) {
  #Guardamos cada jornada como una matriz
  ovrt_19_20 <- c(ovrt_19_20,str_split(var_overturns_19_20[a],"\n",simplify = T))
}

#ya que tenemos los datos de todos los equipos de la 19/20, ahora nos vamos a quedar solamente 
#con los datos útiles, para esto, hacemos un loop, vamos a trimear cada entrada 
#y si la longitud de la entrada después de trimearla es mayor a cero entonces es un dato
#útil y lo guardamos en un nuevo array

#Array en donde vamos a guardar todo
ovrt_data_19_20 <- NULL
#Iniciamos el loop en donde vamos a guardar todos los datos
for (b in 1:length(ovrt_19_20)) {
  #Trimeamos los datos para ver is es que hay datos útiles
  data_trim <- str_trim(ovrt_19_20[b])
  #Si la longitud de lo trimeado es mayor a cero entonces tiene datos útiles
  if(str_length(data_trim) > 0){
    #Guardamos el dato útil en un array 
    ovrt_data_19_20 <- c(ovrt_data_19_20,data_trim)
  }
}

#Hacemos el mismo proceso para los datos de la 20/21

#Se va a guardar todos los datos "servibles" o "útiles" dentro de un solo array
ovrt_20_21 <- NULL
#Vamos a hacer un loop para guardar los datos acerca de los overturns de los equipos de la 20/21
for (c in 1:length(var_overturns_20_21)) {
  #Guardamos cada jornada como una matriz
  ovrt_20_21 <- c(ovrt_20_21,str_split(var_overturns_20_21[c],"\n",simplify = T))
}

#ya que tenemos los datos de todos los equipos de la 20/21, ahora nos vamos a quedar solamente 
#con los datos útiles, para esto, hacemos un loop, vamos a trimear cada entrada 
#y si la longitud de la entrada después de trimearla es mayor a cero entonces es un dato
#útil y lo guardamos en un nuevo array

#Array en donde vamos a guardar todo
ovrt_data_20_21 <- NULL
#Iniciamos el loop en donde vamos a guardar todos los datos
for (d in 1:length(ovrt_20_21)) {
  #Trimeamos los datos para ver is es que hay datos útiles
  data_trim <- str_trim(ovrt_20_21[d])
  #Si la longitud de lo trimeado es mayor a cero entonces tiene datos útiles
  if(str_length(data_trim) > 0){
    #Guardamos el dato útil en un array 
    ovrt_data_20_21 <- c(ovrt_data_20_21,data_trim)
  }
}

#Empezamos a guardar los datos de los overturns en vectores separados para después unirlos en un dataset
ovrt_data_19_20 <- ovrt_data_19_20[1:123]

#Empezamos el loop para los datos de los equipos de ambas temporadas

#Creamos un array para meter los equipos de la temporada 19/20 para cada tipo de overturn
teams_ovrt_19_20 <- NULL
#Creamos un array para meter los puntos a favor o en contra de cada equipo de la 19/20 por cada tipo de 
#overturn
ovrt_points_19_20 <- NULL
#Creamos un array para meter los equipos de la temporada 20/21 para cada tipo de overturn
teams_ovrt_20_21 <- NULL
#Creamos un array para meter los puntos a favor o en contra de cada equipo de la 20/21 por cada tipo de 
#overturn
ovrt_points_20_21 <- NULL
#Creamos un contador para saber si estamos en los primeros 20 overturns, ya que esos primeros 20
#tienen un signo positivo o negativo al principio que debemos quitar
contador_ovrt <- 0
#Empezamos el loop con la longitud de la 19/20 y como ambos tienen la misma longitud esto no 
#importa mucho
for (e in 1:length(ovrt_data_19_20)) {
  #Nos fijamos si la entrada es el título del tipo de overturn, este siempre inicia con la palabra "VAR"
  if (substr(ovrt_data_19_20[e],1,3) == "VAR") {
    #Si estamos en el título del tipo de overturn, entonces sabemos que son 20 equipos por lo tanto
    #hacemos el loop recorriendo los 20 equipos de 2 en 2 que es donde están los equipos
    for(f in seq(e+1,e+39,by=2)){
      #Aumentamos el contador para fijarnos si son los primeros 20
      contador_ovrt <- contador_ovrt + 1
      #Nos fijamos si son los primeros 20 equipos
      if(contador_ovrt <= 20){
        #Nos traemos los puntos con el signo adecuado ya en entero
        ovrt_points_19_20 <- c(ovrt_points_19_20,as.integer(ovrt_data_19_20[f+1]))
        #en este loop solo lidiamos con los signos de los equipos de la temporada 19/20 por lo tanto
        #las primeras 20 entradas del vector para la temporada 20/21 los dejamos en 0
        ovrt_points_20_21 <- c(ovrt_points_20_21,0)
      } else {
        #Si ya pasamos los primeros 20 entonces ya nos traemos el puro número, estos ya no tienen signo
        #y aquí si guardamos para ambas tenporadas
        ovrt_points_19_20 <- c(ovrt_points_19_20,as.integer(ovrt_data_19_20[f+1]))
        ovrt_points_20_21 <- c(ovrt_points_20_21,as.integer(ovrt_data_20_21[f+1]))
      }
      #Después de guardar los puntos guardamos el nombre de los equipos para ambas temporadas
      teams_ovrt_19_20 <- c(teams_ovrt_19_20,ovrt_data_19_20[f])
      teams_ovrt_20_21 <- c(teams_ovrt_20_21,ovrt_data_20_21[f])
    }
  }
}

#Como los primeros 20 puntos no coinciden necesariamente entre ambas temporadas en cuanto signo entonces
#tratamos aquí los primeros 20 puntos de la temporada 20/21

#Creamos un indice el cual nos servirá para saber en que entrada del vector ya creado para la 20/21
#guardar el respectivo punto positivo, negativo o cero
index_20_21 <- 0
#empezamos el loop dentro del vector de datos de la 20/21 para obtener los primeros 20 puntos
for(g in 1:length(ovrt_data_20_21)){
  #Queremos solamente los puntos del tipo net score
  if (ovrt_data_20_21[g] == "VAR overturns (net score)"){
    #Son 20 equipos por lo tanto recorremos el vector solo los primeros 20 de dos en dos a partir 
    #del inicio del overturn más dos lugares
    for(h in seq(g+2,g+40,by=2)){
      #Aumentamos el índice para ir recorriendo los primeros 20 lugares del vector de puntos 
      #para la 20/21
      index_20_21 <- index_20_21 + 1
      #Nos traemos los puntos con el signo adecuado ya en entero
      ovrt_points_20_21[index_20_21] <- as.integer(ovrt_data_20_21[h])
    }
  }
}

#Vamos a guardar estos tres tipos de overturn en un tres tablas diferntes para cada temporada y así después unirlos en uno solo

#ns = net score
#df = decisions for
#da = decisions against

#Tabla para el overturn "net score"
ns_df <- data.frame("season" = c(rep("19/20",20),rep("20/21",20)), "team" = c(teams_ovrt_19_20[1:20],teams_ovrt_20_21[1:20]), "ns" = c(ovrt_points_19_20[1:20],ovrt_points_20_21[1:20]))
#Tabla para el overturn "decisions for"
desfor_df <- data.frame("season" = c(rep("19/20",20),rep("20/21",20)), "team" = c(teams_ovrt_19_20[21:40],teams_ovrt_20_21[21:40]), "df" = c(ovrt_points_19_20[21:40],ovrt_points_20_21[21:40]))
#Tabla para el overturn "decisions against"
desagnst_df <- data.frame("season" = c(rep("19/20",20),rep("20/21",20)), "team" = c(teams_ovrt_19_20[41:60],teams_ovrt_20_21[41:60]), "da" = c(ovrt_points_19_20[41:60],ovrt_points_20_21[41:60]))
#unimos las tres tablas en una sola basado en la temporada y nombre de equipo
ovrt_df <- inner_join(ns_df,desfor_df,by=c("season","team")) %>% inner_join(.,desagnst_df,by=c("season","team"))
```

```{r}
ovrt_df
```

Iniciamos el proceso para obtener la descripción de las decisiones del VAR en los partidos de la Premier League en las temporadas 19/20 y 20/21

```{r,include=FALSE}
#Empezamos a tratar con los datos obtenidos sobre los detalles del VAR en cada partido de la PL y entonces
#solo quedarnos con la info importante

#Se va a guardar todos los datos "servibles" o "útiles" dentro de un solo array
details_19_20 <- NULL
#Vamos a hacer un loop para guardar los datos acerca de las intervenciones del VAR de la 19/20
for (i in 1:length(details_var_19_20)) {
  #Guardamos cada dato como una matriz
  details_19_20 <- c(details_19_20,str_split(details_var_19_20[i],"\n",simplify = T))
}

#ya que tenemos los datos de todos los partidos de la 19/20, ahora nos vamos a quedar solamente 
#con los datos útiles, para esto, hacemos un loop, vamos a trimear cada entrada 
#y si la longitud de la entrada después de trimearla es mayor a cero entonces es un dato
#útil y lo guardamos en un nuevo array

#Array en donde vamos a guardar todo
details_data_19_20 <- NULL
#Iniciamos el loop en donde vamos a guardar todos los datos
for (j in 1:length(details_19_20)) {
  #Trimeamos los datos para ver is es que hay datos útiles
  data_trim <- str_trim(details_19_20[j])
  #Si la longitud de lo trimeado es mayor a cero entonces tiene datos útiles
  if(str_length(data_trim) > 0){
    #Guardamos el dato útil en un array 
    details_data_19_20 <- c(details_data_19_20,data_trim)
  }
}

#Hacemos el mismo proceso para los datos de la 20/21

#Se va a guardar todos los datos "servibles" o "útiles" dentro de un solo array
details_20_21 <- NULL
#Vamos a hacer un loop para guardar los datos acerca de los partidos de los equipos de la 20/21
for (k in 1:length(details_var_20_21)) {
  #Guardamos cada dato como una matriz
  details_20_21 <- c(details_20_21,str_split(details_var_20_21[k],"\n",simplify = T))
}

#ya que tenemos los datos de todos los partidos de la 20/21, ahora nos vamos a quedar solamente 
#con los datos útiles, para esto, hacemos un loop, vamos a trimear cada entrada 
#y si la longitud de la entrada después de trimearla es mayor a cero entonces es un dato
#útil y lo guardamos en un nuevo array

#Array en donde vamos a guardar todo
details_data_20_21 <- NULL
#Iniciamos el loop en donde vamos a guardar todos los datos
for (l in 1:length(details_20_21)) {
  #Trimeamos los datos para ver is es que hay datos útiles
  data_trim <- str_trim(details_20_21[l])
  #Si la longitud de lo trimeado es mayor a cero entonces tiene datos útiles
  if(str_length(data_trim) > 0){
    #Guardamos el dato útil en un array 
    details_data_20_21 <- c(details_data_20_21,data_trim)
  }
}

#Ahora que ya tenemos los datos "útiles" entonces empezamos a guardar los datos en vectores 

#Empezamos el proceso para traernos la descripciones de decisiones del VAR

des_19_20 <- NULL

for (m in 1:length(details_data_19_20)) {
  if(details_data_19_20[m] == "Overturns:"){
    for (n in seq(m+1,m+17,by=2)) {
      des_19_20 <- c(des_19_20,details_data_19_20[n])
    }
  }
}

overturns_19_20 <- NULL
#leading goals for
lgf_19_20 <- NULL
#disallowed goals for
dgf_19_20 <- NULL
#leading goals against
lga_19_20 <- NULL
#disallowed goals against
dga_19_20 <- NULL
#net goal score
ngs_19_20 <- NULL
#subjective decisions for
sdf_19_20 <- NULL
#subjective decisions against
sda_19_20 <- NULL
#net subjective score
nsc_19_20 <- NULL

for (o in seq(1,9*19+1,by=9)) {
  overturns_19_20 <- c(overturns_19_20,as.integer(des_19_20[o]))
  lgf_19_20 <- c(lgf_19_20,as.integer(des_19_20[o+1]))
  dgf_19_20 <- c(dgf_19_20,as.integer(des_19_20[o+2]))
  lga_19_20 <- c(lga_19_20,as.integer(des_19_20[o+3]))
  dga_19_20 <- c(dga_19_20,as.integer(des_19_20[o+4]))
  ngs_19_20 <- c(ngs_19_20,as.integer(des_19_20[o+5]))
  sdf_19_20 <- c(sdf_19_20,as.integer(des_19_20[o+6]))
  sda_19_20 <- c(sda_19_20,as.integer(des_19_20[o+7]))
  nsc_19_20 <- c(nsc_19_20,as.integer(des_19_20[o+8]))
}

des_df <- data.frame("season" = rep("19/20",20),"team" = teams_ovrt_19_20[1:20],"ovrt" = overturns_19_20,
                     "lgf" = lgf_19_20,"dgf" = dgf_19_20,"lga" = lga_19_20,"dga" = dga_19_20,
                     "ngs" = ngs_19_20,"sdf" = sdf_19_20,"sda" = sda_19_20,"nsc" = nsc_19_20)

ovrt_df_2 <- left_join(ovrt_df,des_df,by=c("season","team"))
```

```{r}
ovrt_df_2
```

```{r,include=FALSE}
#Escribimos las tablas en archivos csv para no perderlos
#write_csv(premier_league,"/Users/pedrovela/Documentos/Git_repos/VAR_soccer/premier_league.csv")
#write_csv(ovrt_df,"/Users/pedrovela/Documentos/Git_repos/VAR_soccer/pl_overturns.csv")
```

De aquí ya tenemos datos acerca de 1900 partidos de la PL desde 2016, de aquí podemos empezar a hacer análisis exploratorio.

**Tal vez agregar al campeón de cada temporada, nos podría servir como indicador de algo en cuanto a métricas**
