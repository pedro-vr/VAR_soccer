---
title: "VAR in football"
author: "Pedro Alan Velázquez Romero"
date: "5/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
#librerias a utilizar 
#install.packages(c("dplyr","ggplot2","tidyr","httr","XML","rvest","xml2","tidyverse","robotstxt",
            #       "urltools"))
library(dplyr)
library(ggplot2)
library(tidyr)
library(httr)
library(XML)
library(rvest)
library(xml2)
library(tidyverse)
library(robotstxt)
library(urltools)
```

Esta es la primera versión del documento en donde se harán los cálculos para el análisis del VAR en el fútbol. A partir de aquí se va a empezar con un análisis descriptivo de los datos, además de reconocer los datos verdaderamente valiosos con los que se trabajará.

El primer acercamiento por supuesto es sobre el VAR como nueva medida en el fútbol, de aquí que sale el repentino interés de querer saber lo siguiente:

1. En qué fecha se implementó el VAR? A partir de ahí podemos hacer comparaciones entre métricas de equipos antes y después del VAR
2. Si se puede conseguir datos del VAR en México entonces también podemos comparar el efecto del VAR y además el efecto del recién implementado repechaje en México

Implementación del VAR en México: **2018 en el torneo Apertura como piloto, se implementó en 2019 de manera oficial**

Propuestas de métricas para medir la ineficiencia/eficiencia del VAR (Arturo Brizio, presidente de la Comisión de Árbitros en México):

1. La unificación de procedimientos
2. La línea de intervención (equilibrio entre poco y nunca, solamente when necessary)
3. Tiempo de revisión (el promedio hasta marzo 2021 es de 1.5 mins, el máximo es 9 mins)
4. Medidas PEGII: Penal, Expulsión, Gol, Identidad errónea e Incidente no visto por el árbitro

Fuente: https://www.marca.com/claro-mx/futbol/liga-mx/2021/03/25/605cfb42ca4741d5138b4612.html

VAR definición: https://www.marca.com/claro-mx/futbol/liga-mx/2018/10/18/5bc8a11a268e3ebb268b45ce.html


Si obtenemos el documento directamente de la página de GitHub de FiveThirtyEight se tienen los partidos actualizados al día.

```{r}
#al parecer aquí ya se encuentran desde 2016 hasta hoy, se actualiza cada semana
football_matches <- read.csv("https://projects.fivethirtyeight.com/soccer-api/club/spi_matches.csv")
#filtramos solamente la liga mx
liga_mx <- filter(football_matches,league == 'Mexican Primera Division Torneo Clausura' | league == 'Mexican Primera Division Torneo Apertura')
```

Las liguillas del torneo mexicano se dieron en las siguientes fechas:

- Clausura 2016: 10 mayo 2017 a 28 mayo 2017
- Apertura 2017: 22 noviembre 2017 a 10 diciembre 2017
- Clausura 2017: 2 mayo 2018 a 20 mayo 2018
- Apertura 2018: 28 noviembre 2018 a 16 diciembre 2018
- Clausura 2018: 8 mayo 2019 a 26 mayo 2019
- Apertura 2019: 27 noviembre 2019 a 29 diciembre 2019
- Clausura 2019: Suspendido por COVID
- Apertura 2020 (Guardianes 2020): 21 noviembre 2020 a 13 diciembre 2020
- Clausura 2020 (Guardianes 2021): 8 mayo 2021 a 30 mayo 2021 

El VAR inicia oficialmente en México en el año 2019 (Clausura 2018)

```{r}
#Empezamos el proceso para crear una columna en donde diga si el partido es temporada
#regular o liguilla
liga_mx <- liga_mx %>% mutate(reg_season = if_else(as.POSIXct(date) > as.POSIXct('2017-05-09')
                                                   & as.POSIXct(date) < as.POSIXct('2017-05-29'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2017-11-21')
                                                   & as.POSIXct(date) < as.POSIXct('2017-12-11'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2018-05-01')
                                                   & as.POSIXct(date) < as.POSIXct('2018-05-21'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2018-11-27')
                                                   & as.POSIXct(date) < as.POSIXct('2018-12-17'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2019-05-07')
                                                   & as.POSIXct(date) < as.POSIXct('2019-05-27'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2019-11-26')
                                                   & as.POSIXct(date) < as.POSIXct('2019-12-30'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2020-11-20')
                                                   & as.POSIXct(date) < as.POSIXct('2020-12-14'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2021-05-07')
                                                   & as.POSIXct(date) < as.POSIXct('2021-05-31'),1,0)))))))))
#Creamos otra variable para determinar en qué momento inició COVID
liga_mx <- liga_mx %>% mutate(after_covid = if_else(as.POSIXct(date) > as.POSIXct('2020-03-16'),1,0))
#Creamos la variable que nos indica si en el partido estuvo presente el VAR
liga_mx <- liga_mx %>% mutate(is_VAR = if_else(format(as.Date(date),"%Y") >= 2019,1,0))
```

```{r}
head(liga_mx,3)
```

Tal vez incluir el equipo campeón y subcampeón en nuevas columnas


