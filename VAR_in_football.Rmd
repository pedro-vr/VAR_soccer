---
title: "VAR in football"
author: "Pedro Alan Velázquez Romero"
date: "5/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
#librerias a utilizar 
#install.packages(c("dplyr","ggplot2","tidyr","httr","XML","rvest","xml2","tidyverse","robotstxt",
            #       "urltools"))
library(dplyr)
library(ggplot2)
library(tidyr)
library(httr)
library(XML)
library(rvest)
library(xml2)
library(tidyverse)
library(robotstxt)
library(urltools)
library(XML)
library(methods)
```

Esta es la primera versión del documento en donde se harán los cálculos para el análisis del VAR en el fútbol. A partir de aquí se va a empezar con un análisis descriptivo de los datos, además de reconocer los datos verdaderamente valiosos con los que se trabajará.

El primer acercamiento por supuesto es sobre el VAR como nueva medida en el fútbol, de aquí que sale el repentino interés de querer saber lo siguiente:

1. En qué fecha se implementó el VAR? A partir de ahí podemos hacer comparaciones entre métricas de equipos antes y después del VAR
2. Si se puede conseguir datos del VAR en México entonces también podemos comparar el efecto del VAR y además el efecto del recién implementado repechaje en México

Implementación del VAR en México: **2018 en el torneo Apertura como piloto, se implementó en 2019 de manera oficial**

Propuestas de métricas para medir la ineficiencia/eficiencia del VAR (Arturo Brizio, presidente de la Comisión de Árbitros en México):

1. La unificación de procedimientos
2. La línea de intervención (equilibrio entre poco y nunca, solamente when necessary)
3. Tiempo de revisión (el promedio hasta marzo 2021 es de 1.5 mins, el máximo es 9 mins)
4. Medidas PEGII: Penal, Expulsión, Gol, Identidad errónea e Incidente no visto por el árbitro

Fuente: https://www.marca.com/claro-mx/futbol/liga-mx/2021/03/25/605cfb42ca4741d5138b4612.html

VAR definición: https://www.marca.com/claro-mx/futbol/liga-mx/2018/10/18/5bc8a11a268e3ebb268b45ce.html


Si obtenemos el documento directamente de la página de GitHub de FiveThirtyEight se tienen los partidos actualizados al día.

```{r}
#al parecer aquí ya se encuentran desde 2016 hasta hoy, se actualiza cada semana
url <- "https://projects.fivethirtyeight.com/soccer-api/club/spi_matches.csv"
football_matches <- read.csv(url,fileEncoding = 'UTF-8',skipNul = T)
#filtramos solamente la liga mx
liga_mx <- filter(football_matches,league == 'Mexican Primera Division Torneo Clausura' | league == 'Mexican Primera Division Torneo Apertura')
```

Las liguillas del torneo mexicano se dieron en las siguientes fechas:

- Clausura 2016: 10 mayo 2017 a 28 mayo 2017
- Apertura 2017: 22 noviembre 2017 a 10 diciembre 2017
- Clausura 2017: 2 mayo 2018 a 20 mayo 2018
- Apertura 2018: 28 noviembre 2018 a 16 diciembre 2018
- Clausura 2018: 8 mayo 2019 a 26 mayo 2019
- Apertura 2019: 27 noviembre 2019 a 29 diciembre 2019
- Clausura 2019: Suspendido por COVID
- Apertura 2020 (Guardianes 2020): 21 noviembre 2020 a 13 diciembre 2020
- Clausura 2020 (Guardianes 2021): 8 mayo 2021 a 30 mayo 2021 

El VAR inicia oficialmente en México en el año 2019 (Clausura 2018)

```{r}
#Empezamos el proceso para crear una columna en donde diga si el partido es temporada
#regular o liguilla
liga_mx <- liga_mx %>% mutate(reg_season = if_else(as.POSIXct(date) > as.POSIXct('2017-05-09')
                                                   & as.POSIXct(date) < as.POSIXct('2017-05-29'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2017-11-21')
                                                   & as.POSIXct(date) < as.POSIXct('2017-12-11'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2018-05-01')
                                                   & as.POSIXct(date) < as.POSIXct('2018-05-21'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2018-11-27')
                                                   & as.POSIXct(date) < as.POSIXct('2018-12-17'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2019-05-07')
                                                   & as.POSIXct(date) < as.POSIXct('2019-05-27'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2019-11-26')
                                                   & as.POSIXct(date) < as.POSIXct('2019-12-30'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2020-11-20')
                                                   & as.POSIXct(date) < as.POSIXct('2020-12-14'),1,
                                                   if_else(as.POSIXct(date) > as.POSIXct('2021-05-07')
                                                   & as.POSIXct(date) < as.POSIXct('2021-05-31'),1,0)))))))))
#Creamos otra variable para determinar en qué momento inició COVID
liga_mx <- liga_mx %>% mutate(after_covid = if_else(as.POSIXct(date) > as.POSIXct('2020-03-16'),1,0))
#Creamos la variable que nos indica si en el partido estuvo presente el VAR
liga_mx <- liga_mx %>% mutate(is_VAR = if_else(format(as.Date(date),"%Y") >= 2019,1,0))
```

```{r,include=FALSE}
head(liga_mx,3)
arrange(liga_mx,desc(date))
arrange(liga_mx,date)
```

```{r}
#empezamos a leer el XML con los datos del año 2016
#leemos el archivo desde el el cual vamos a obtener los datos
clausura_2016 <- htmlParse("/Users/pedrovela/Documentos/Git_repos/VAR_soccer/clausura_2016.html")
#En los nodos "strong" podemos obtener los marcadores y algunas probabilidades de los partidos
resultados_cl <- getNodeSet(clausura_2016, '//strong[1]') %>% sapply(., xmlValue)
#En los nodos "a" podemos obtener el nombre de los equipos 
equipos_cl <- getNodeSet(clausura_2016, '//a[1]') %>% sapply(., xmlValue)
#En los nodos "div" podemos obtener las probabilidades de los partidos
probabilidades_cl <- getNodeSet(clausura_2016, '//div[1]') %>% sapply(., xmlValue)
```

```{r}
#Empezamos a obtener los resultados de los partidos de la clausura
#Creamos una variable nula que será el vector con todos los resultados
marcadores_cl <- NULL
#Guardamos el número de índice donde está el marcador de la jornada 6
indice_j6 <- 0
#Empezamos con el loop para obtener los marcadores
#En este torneo se disputó un partido de la jornada 6 en una fecha diferente entonces
#se debe tomar en cuenta para poder asignarlo a la jornada correspondiente
for (nodo in 1:length(resultados_cl)) {
  #El marcador del partido pospuesto de la jornada 6 está en la entrada 145
  if(nodo == 145){
    #Agregamos el indicador "jornada 6" para saber en donde está el marcador correspondiente
    marcadores_cl <- c(marcadores_cl,resultados_cl[146])
    indice_j6 <- length(marcadores_cl)
  } else {
      #Sabemos que antes de los marcadores de cada jornada está la frase 
      #"Fixtures & Results Liga MX Clausura" entonces la buscamos y sabemos que 
      #a partir de ahí vienen los marcadores en posiciones impares subsecuentes (1,3,5,..,17)
      if(resultados_cl[nodo] == "Fixtures & Results Liga MX Clausura"){
        for (i in seq(1,17,by=2)) {
          #En la jornada 6 como se jugó un partido menos entonces debemos de recorrer una vez menos a 
          #i o checar que en verdad nos traigamos marcadores y no otra cosa
          if(resultados_cl[nodo+i] != "Fixtures & Results Liga MX Clausura"){
            #Agregamos el marcador al vector
            marcadores_cl <- c(marcadores_cl,resultados_cl[nodo+i])
          }
        }
      } 
    }
}
#Empezamos a tratar el vector de los marcadores para separar el marcador del equipo local y equipo
#visitante
#Vector con goles del equipo local
score1_cl <- NULL
#Vector con goles del equipo visitante
score2_cl <- NULL
for (t in 1:length(marcadores_cl)) {
  if(marcadores_cl[t] != 'jornada 6'){
    score1_cl <- c(score1_cl,as.integer(substr(marcadores_cl[t],1,1)))
    score2_cl <- c(score2_cl,as.integer(substr(marcadores_cl[t],3,3)))
  }
}
```

De aquí arriba falta traerse el \% de probabilidad de gane/empate/pérdida del equipo que resultó victorioso en el partido (o empate)

```{r}
#empezamos a leer el XML con los datos del año 2016
#leemos el archivo desde el el cual vamos a obtener los datos
apertura_2016 <- htmlParse("/Users/pedrovela/Documentos/Git_repos/VAR_soccer/apertura_2016.html")
#En los nodos "strong" podemos obtener los marcadores y algunas probabilidades de los partidos
resultados_ap <- getNodeSet(apertura_2016, '//strong[1]') %>% sapply(., xmlValue)
#En los nodos "a" podemos obtener el nombre de los equipos 
equipos_ap <- getNodeSet(apertura_2016, '//a[1]') %>% sapply(., xmlValue)
#En los nodos "div" podemos obtener las probabilidades de los partidos
probabilidades_ap <- getNodeSet(apertura_2016, '//div[1]') %>% sapply(., xmlValue)
```

```{r}
#Empezamos a obtener los resultados de los partidos de la clausura
#Creamos una variable nula que será el vector con todos los resultados
marcadores_ap <- NULL
#Empezamos con el loop para obtener los marcadores
for (x in 1:length(resultados_ap)) {
  #Sabemos que antes de los marcadores de cada jornada está la frase 
  #"Fixtures & Results Liga MX Apertura" entonces la buscamos y sabemos que 
  #a partir de ahí vienen los marcadores en posiciones impares subsecuentes (1,3,5,..,17)
  if(resultados_ap[x] == "Fixtures & Results Liga MX Apertura"){
    for (i in seq(1,17,by=2)) {
      #Agregamos el marcador al vector
      marcadores_ap <- c(marcadores_ap,resultados_ap[x+i])
    }
  }
}
#Empezamos a tratar el vector de los marcadores para separar el marcador del equipo local y equipo
#visitante
#Vector con goles del equipo local
score1_ap <- NULL
#Vector con goles del equipo visitante
score2_ap <- NULL
for (s in 1:length(marcadores_ap)) {
  score1_ap <- c(score1_ap,as.integer(substr(marcadores_ap[s],1,1)))
  score2_ap <- c(score2_ap,as.integer(substr(marcadores_ap[s],3,3)))
}

#Al final unimos los dos vectores de marcadores para tener uno solo
score1 <- c(score1_cl,score1_ap)
score2 <- c(score2_cl,score2_ap)

#imprimimos los resultados
print(score1)
```

De aquí arriba falta traerse el \% de probabilidad de gane/empate/pérdida del equipo que resultó victorioso en el partido (o empate)

```{r}
#Empezamos el proceso para obtener el % de probabilidad de ganar para el torneo de clausura
#Empezamos a obtener los resultados de los partidos de la clausura
#Creamos una variable nula que será el vector con todas las probabilidades
prob_cl <- NULL
#Guardamos el número de índice donde está el marcador de la jornada 6
indice2_j6 <- 0
#Empezamos con el loop para obtener las probabilidades
#En este torneo se disputó un partido de la jornada 6 en una fecha diferente entonces
#se debe tomar en cuenta para poder asignarlo a la jornada correspondiente
for (x in 1:length(resultados_cl)) {
  #La probabilidad del partido pospuesto de la jornada 6 está en la entrada 145
  if(x == 145){
    #Agregamos el indicador "jornada 6" para saber en donde está la probabilidad correspondiente
    prob_cl <- c(prob_cl,resultados_cl[147])
    indice2_j6 <- length(prob_cl)
  } else {
      #Sabemos que antes de los marcadores de cada jornada está la frase 
      #"Fixtures & Results Liga MX Clausura" entonces la buscamos y sabemos que 
      #a partir de ahí vienen las probabilidades en posiciones impares subsecuentes (2,4,6,..,18)
      if(resultados_cl[x] == "Fixtures & Results Liga MX Clausura"){
        for (i in seq(2,18,by=2)) {
          #En la jornada 6 como se jugó un partido menos entonces debemos de recorrer una vez menos a 
          #i o checar que en verdad nos traigamos probabilidades y no otra cosa
          if(resultados_cl[x+i-1] != "Fixtures & Results Liga MX Clausura"){
            #Agregamos la probabilidad al vector
            prob_cl <- c(prob_cl,resultados_cl[x+i])
          }
        }
      } 
    }
}
#Empezamos el mismo proceso para obtener probabilidades del torneo de apertura
#Creamos una variable nula que será el vector con todas las probabilidades
prob_ap <- NULL
#Empezamos con el loop para obtener las probabilidades
for (x in 1:length(resultados_ap)) {
  #Sabemos que antes de los marcadores de cada jornada está la frase 
  #"Fixtures & Results Liga MX Clausura" entonces la buscamos y sabemos que 
  #a partir de ahí vienen las probabilidades en posiciones pares subsecuentes (2,4,6,..,18)
  if(resultados_ap[x] == "Fixtures & Results Liga MX Apertura"){
    for (i in seq(2,18,by=2)) {
      #Agregamos la probabilidad al vector
      prob_ap <- c(prob_ap,resultados_ap[x+i])
    }
  }
}
```

```{r}
#Empezamos el proceso para obtener el vector de puras probabilidades

#Proceso para la Clausura
#Vector que guardará la probabilidad del equipo local
prob1_cl <- NULL
#Vector que guardará la probabilidad del equipo visitante
prob2_cl <- NULL
#Vector que guardará la probabilidad de empate
probtie_cl <- NULL
#Empezamos el loop para obtener las probabilidades en tipo double
for (a in 1:length(score1_cl)) {
    #Checamos quien ganó el partido, el local, el visitante o empate
    if(score1_cl[a] > score2_cl[a]){
      #Guardamos la probabilidad si el local ganó
      prob1_cl <- c(prob1_cl,as.double(substr(prob_cl[a],1,2))/100)
    } else {
      #Si no gano el local entonces agregamos un cero para guardar el lugar 
      prob1_cl <- c(prob1_cl,0.00)
    }
    #Checamos quien ganó el partido, el local, el visitante o empate
    if(score1_cl[a] < score2_cl[a]){
      #Guardamos la probabilidad si el visitante ganó
      prob2_cl <- c(prob2_cl,as.double(substr(prob_cl[a],1,2))/100)
    } else {
      #Si no gano el visitante entonces agregamos un cero para guardar el lugar 
      prob2_cl <- c(prob2_cl,0.00)
    }
    #Checamos quien ganó el partido, el local, el visitante o empate
    if(score1_cl[a] == score2_cl[a]){
      #Guardamos la probabilidad si hubo empate
      probtie_cl <- c(probtie_cl,as.double(substr(prob_cl[a],1,2))/100)
    } else {
      #Si no hubo empate entonces agregamos un cero para guardar el lugar 
      probtie_cl <- c(probtie_cl,0.00)
    }
}

#Proceso para la Apertura
#Vector que guardará la probabilidad del equipo local
prob1_ap <- NULL
#Vector que guardará la probabilidad del equipo visitante
prob2_ap <- NULL
#Vector que guardará la probabilidad de empate
probtie_ap <- NULL
#Empezamos el loop para obtener las probabilidades en tipo double
for (b in 1:length(score1_ap)) {
  #Checamos quien ganó el partido, el local, el visitante o empate
  if(score1_ap[b] > score2_ap[b]){
    #Guardamos la probabilidad si el local ganó
    prob1_ap <- c(prob1_ap,as.double(substr(prob_ap[b],1,2))/100)
  } else {
    #Si no gano el local entonces agregamos un cero para guardar el lugar 
    prob1_ap <- c(prob1_ap,0.00)
  }
  #Checamos quien ganó el partido, el local, el visitante o empate
  if(score1_ap[b] < score2_ap[b]){
    #Guardamos la probabilidad si el visitante ganó
    prob2_ap <- c(prob2_ap,as.double(substr(prob_ap[b],1,2))/100)
  } else {
    #Si no gano el visitante entonces agregamos un cero para guardar el lugar 
    prob2_ap <- c(prob2_ap,0.00)
  }
  #Checamos quien ganó el partido, el local, el visitante o empate
  if(score1_ap[b] == score2_ap[b]){
    #Guardamos la probabilidad si hubo empate
    probtie_ap <- c(probtie_ap,as.double(substr(prob_ap[b],1,2))/100)
  } else {
    #Si no hubo empate entonces agregamos un cero para guardar el lugar 
    probtie_ap <- c(probtie_ap,0.00)
  }
}

print(prob1_ap)
```

```{r}
#Empezamos con el proceso para obtener los equipos visitantes y locales de cada jornada para el clausura 
#Vector que guardará a los equipos locales 
team1_cl <- NULL
#Vector que guardará a los equipos visitantes
team2_cl <- NULL
#Empezamos el loop para obtener los equipos, sabemos que la los primeros equipos empiezan en el 
#índice 338 y de ahí es cada 2da entrada 
for (d in seq(338,642,by=2)) {
  #Agregamos el equipo local
  team1_cl <- c(team1_cl,substr(equipos_cl[d],1,str_locate(equipos_cl[d],"-")[1]-2))
  #Agregamos el equipo visitante
  team2_cl <- c(team2_cl,substr(equipos_cl[d],str_locate(equipos_cl[d],"-")[1]+2,str_length(equipos_cl[d])))
}
print(team1_cl)
```

```{r}
#Empezamos con el proceso para obtener los equipos visitantes y locales de cada jornada para el clausura 
#Vector que guardará a los equipos locales 
team1_ap <- NULL
#Vector que guardará a los equipos visitantes
team2_ap <- NULL
#Empezamos el loop para obtener los equipos, sabemos que la los primeros equipos empiezan en el 
#índice 338 y de ahí es cada 2da entrada 
for (c in seq(338,642,by=2)) {
  #Agregamos el equipo local
  team1_ap <- c(team1_ap,substr(equipos_ap[c],1,str_locate(equipos_ap[c],"-")[1]-2))
  #Agregamos el equipo visitante
  team2_ap <- c(team2_ap,substr(equipos_ap[c],str_locate(equipos_ap[c],"-")[1]+2,
                                str_length(equipos_ap[c])))
}
print(team1_ap)

#Unimos los vectores de los equipos de clausura y apertura para tener uno solo
team1 <- c(team1_cl,team1_ap)
team2 <- c(team2_cl,team2_ap)
```

**Convertir todos los nombres de los equipos en liga_mx a character**

Tal vez incluir el equipo campeón y subcampeón en nuevas columnas


