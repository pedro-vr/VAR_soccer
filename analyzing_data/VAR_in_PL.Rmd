---
title: "El VAR en la EPL"
author: "Pedro Alan Velázquez Romero"
date: "10/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
#librerias a utilizar 

#install.packages(c("dplyr","ggplot2","tidyr","httr","XML","rvest","xml2","tidyverse","robotstxt",
#                "urltools","fmsb","devtools","vcd","aplpack","GGally"))
#devtools::install_github("ricardo-bion/ggradar", dependencies=TRUE)
#install.packages(c("wesanderson","e1071"))
library(dplyr)
library(ggplot2)
library(tidyr)
library(httr)
library(XML)
library(rvest)
library(xml2)
library(tidyverse)
library(robotstxt)
library(urltools)
library(XML)
library(methods)
library(ggradar)
library(scales)
library(tibble)
library(fmsb)
library(vcd)
library(GGally)
library(aplpack)
library(e1071)
library(wesanderson)
library(gridExtra)
```

```{r,include=FALSE}
#Datos a utilizar 

work_computer = F

if(work_computer){
  pl_matches <- read.csv('/Users/pedro.velazquez/Library/Mobile Documents/com~apple~CloudDocs/Documents/Git_repos/VAR_soccer/tables/premier_league.csv')
  pl_ot <- read.csv('/Users/pedro.velazquez/Library/Mobile Documents/com~apple~CloudDocs/Documents/Git_repos/VAR_soccer/tables/pl_overturns_var.csv')
  pl_var_inc <- read.csv('/Users/pedro.velazquez/Library/Mobile Documents/com~apple~CloudDocs/Documents/Git_repos/VAR_soccer/tables/var_details.csv') #incluye el flag de si el team1 es local o visitante en el partido en cuestión
  pl_var_inc1 <- read.csv('/Users/pedro.velazquez/Library/Mobile Documents/com~apple~CloudDocs/Documents/Git_repos/VAR_soccer/tables/var_details1.csv')
} else {
  pl_matches <- read.csv('/Users/pedrovela/Documents/Git_repos/VAR_soccer/tables/premier_league.csv')
  pl_ot <- read.csv('/Users/pedrovela/Documents/Git_repos/VAR_soccer/tables/pl_overturns_var.csv')
  pl_var_inc <- read.csv('/Users/pedrovela/Documents/Git_repos/VAR_soccer/tables/var_details.csv') #incluye el flag de si el team1 es local o visitante en el partido en cuestión
  pl_var_inc1 <- read.csv('/Users/pedrovela/Documents/Git_repos/VAR_soccer/tables/var_details1.csv') 
}
```

```{r,include=FALSE}
#Declaramos funciones a utilizar

#función para saber si un equipo pertenece al big six
is_big_six <- function(teams){
  bs_teams <- c('Chelsea','Liverpool','Manchester United','Arsenal','Manchester City','Tottenham Hotspur')
  bs <- NULL
  for (equipo in teams) {
    if(equipo %in% bs_teams)
      bs <- c(bs,'Big Six')
    else
      bs <- c(bs,'No Big Six')
  }
  return(bs)
}

#Función para poder incluir texto en color
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color,
      x)
  } else x
}
```

```{r,include=FALSE}
pl_matches$date <- as.POSIXct(pl_matches$date)
pl_matches$league <- as.character(pl_matches$league)
pl_matches$team1 <- as.character(pl_matches$team1)
pl_matches$team2 <- as.character(pl_matches$team2)
pl_ot$season <- as.character(pl_ot$season)
pl_ot$team <- as.character(pl_ot$team)
pl_var_inc$season <- as.character(pl_var_inc$season)
pl_var_inc$team1 <- as.character(pl_var_inc$team1)
pl_var_inc$team2 <- as.character(pl_var_inc$team2)
pl_var_inc$home.away <- as.character(pl_var_inc$home.away)
pl_var_inc$date <- as.character.Date(pl_var_inc$date)
pl_var_inc$incident <- as.character(pl_var_inc$incident)
pl_var_inc$type <- as.character(pl_var_inc$type)
pl_var_inc1$season <- as.character(pl_var_inc1$season)
pl_var_inc1$team1 <- as.character(pl_var_inc1$team1)
pl_var_inc1$team2 <- as.character(pl_var_inc1$team2)
pl_var_inc1$date <- as.character.Date(pl_var_inc1$date)
pl_var_inc1$incident <- as.character(pl_var_inc1$incident)
pl_var_inc1$type <- as.character(pl_var_inc1$type)
pl_var_inc$big_six <- as.factor(pl_var_inc$big_six)
pl_var_inc$big_six_h <- as.factor(pl_var_inc$big_six_h)
pl_var_inc$big_six_a <- as.factor(pl_var_inc$big_six_a)
pl_var_inc$big_six_both <- as.factor(pl_var_inc$big_six_both)
pl_var_inc$no_big_six_both <- as.factor(pl_var_inc$no_big_six_both)
pl_var_inc$bs_vs_nbs <- as.factor(pl_var_inc$bs_vs_nbs)
pl_matches$season2 <- as.character(pl_matches$season2)

pl_ot['big_six'] <- is_big_six(pl_ot$team)
```

# 1. Introducción

El fútbol es un deporte que ha ido cambiando con el paso de los años, en parte por a revolución tecnológica que se vive día a día, y por lo tanto nosotros como aficionados a este bello deporte debemos también adaptarnos a estos cambios constantes y aprender a disfrutarlos en su esencia más pura. Desde cambios a reglas del juego en cancha, hasta implementaciones tecnológicas, el fútbol siempre está en constante movimiento; uno de los cambios más recientes que vivió el fútbol fue la implementación de una nueva herramienta tecnológica quye ayudaría a las decisiones arbitrales dentro de cada partido: el **Árbitro Asistente de Video** (**VAR** por sus siglas en inglés), el cual fue implementado oficialmente en el año 2017 en algunas ligas. Esta nueva herramienta consiste básicamente en una sala de asistencia arbitral en donde tres personas (árbitros profesionales de fútbol) tienen acceso a las diferentes tomas de televisión del partido en cuestión con repeticiones con el fin de poder analizar con más detalle las jugadas "polémicas" que pudiesen llegar a suscitarse dentro del partido de fútbol, básicamente es una herramienta que pretende ayudar a corregir los errores humanos que pudiesen llegar a cometer los árbitros de fútbol en cancha. 

De acuerdo a la Federación Internacional de Fútbol Asociación (FIFA por sus siglas en inglés), la máxima organización de fútbol en el mundo, el propósito del VAR no es revisar cada jugada o falta que sucede dentro del partido, éste solo se limita a la revisión de ciertas acciones, tales como las siguientes (FIFA, 2017):

1. Penales

    + Penales no marcados
  
    + Penales mal marcados
  
    + Falta o fuera de juego previo al penal
  
    + Balón fuera del terreno del juego previo a la jugada que derivó en penal

2. Expulsiones

    + Tarjeta roja directa (no revisa casos de segundas amarillas)
  
    + Alguna falta no observada por el árbitro en la cancha que amerite roja directa
  
    + Expulsiones erróneas a jugadores

3. Goles

    + Fuera de juego previo al gol o en jugada de gol
  
    + Que el balón esté dentro del terreno de juego previo al gol
  
    + Falta por parte del equipo atacante en la anotación
  
    + Revisión para confirmación o anulación de gol

4. Identidad errónea

    + Si se expulsa o amonesta al jugador equivocado

5. Incidentes no vistos

    + Sucesos que sucedan dentro de la cancha y que el árbitro no haya visto

Es importante señalar aquí que la decisión final siempre la tiene el árbitro en cancha, el VAR simplemente sirve como ayuda para segundas revisiones de jugadas, más no funge como árbitro oficial dentro del partido, por lo tanto, siempre se puede recaer en más errores humanos, debido a que los criterios de los árbitros difieren entre ellos, aún cuando el VAR haya intervenido.

La importancia de esta nueva herramienta dentro del fútbol radica en que siempre dentro de un partido se suscitan muchos eventos de los cuales no siempre se tiene la mejor apreciación por parte del árbitro central y, por lo tanto, es fácil que se cometan muchos errores humanos en marcaciones que pueden llegar a afectar el curso e incluso el marcador final de los partidos. Por ello es que surgió el interés de realizar el siguiente estudio sobre la participación del VAR dentro del fútbol a dos años de su implementación a nivel mundial. 

El propósito del siguiente estudio es señalar el tipo de desempeño que ha tenido el VAR dentro del fútbol de manera general, por un lado, y por otro lado también señalar el impacto que ha tenido el VAR en los equipos de fútbol en cuanto a su desempeño se refiere, para ello, se pretende medir algunas variables como goles anotados, oportunidades creadas, entre otras, con el fin de poder discernir si es que el VAR ha sido benéfico o si, al contrario, ha resultado perjudicial para el fútbol en cuanto a resultados y en cuanto a espectáculo se refiere.

# 2. Datos 

Los datos que se utilizaron para realizar la siguiente investigación son solamente sobre la liga profesional de Inglaterra (EPL por sus siglas en inglés), esto debido enteramente a que es la liga de la cual se tienen más datos acerca de las características de sus partidos y sobre el desempeño del VAR en sus dos temporadas de debut (2019/2020 y 2020/2021).

Las características de los datos que se tienen, junto a sus fuentes, para la investigación son las siguientes:

1. Información acerca de las características de cada partido jugado en la EPL desde la temporada 2016/2017 hasta la temporada 2020/2021. Las características de los partidos que se toman en cuenta aquí son los goles anotados, la probabilidad de victoria de cada equipo, los goles esperados, entre otras. Los datos se tomaron de la página [FiveThirtyEight](https://data.fivethirtyeight.com).

2. Información detallada acerca de las intervenciones del VAR, si es que hubo, dentro de cada partido de la EPL de las temporadas 19/20 y 20/21. Los detalles que se tienen aquí son la descripción del incidente en donde intervino el VAR, el minuto en que sucedió el incidente, los equipos involucrados y el tipo de intervención del VAR (a favor o en contra) con respecto al equipo en cuestión. Los datos se tomaron de los artículos en línea [_How VAR decisions affected every Premier League club in 2019-20_](https://www.espn.com/soccer/english-premier-league/story/3929823/how-var-decisions-have-affected-every-premier-league-club) y [_How VAR decisions affected every Premier League club in 2020-21_](https://www.espn.com/soccer/english-premier-league/story/4182135/how-var-decisions-affected-every-premier-league-club-in-2020-21) de la cadena de televisión ESPN.

3. Información acerca de las métricas que miden los tipos de intervención que tuvo el VAR hacia los diferentes equipos de la EPL durante las temporadas 19/20 y 20/21. Las métricas que se toman en cuenta aquí son el número de goles anulados a favor, el número de goles anulados en contra, número total de decisiones a favor, número total de decisiones en contra, entre otras. Los datos se tomaron de los artículos en línea [_How VAR decisions affected every Premier League club in 2019-20_](https://www.espn.com/soccer/english-premier-league/story/3929823/how-var-decisions-have-affected-every-premier-league-club) y [_How VAR decisions affected every Premier League club in 2020-21_](https://www.espn.com/soccer/english-premier-league/story/4182135/how-var-decisions-affected-every-premier-league-club-in-2020-21) de la cadena de televisión ESPN.

Estos datos se guardaron en forma de datasets para su posterior análisis.

# 3. Resultados esperados

Esta sección es importante para poder señalar nuestras espectativas para con esta investigación, es importante poder señalar el pensamiento inicial que se tiene paera realizar esta investigación para así poder compararlo con los resultados finales que se obtengan y, solo entonces, poder decir si es que se cumplieron las expectativas iniciales o si, por otro lado, las expectativas no se satisficieron y se obtuvieron otros resultados diferentes (e incluso tal vez más interesantes que los iniciales).

Para esta investigación acerca del desempeño del VAR en el fútbol moderno se tienen algunas expectativas muy claras a raíz del mero funcionamiento y propósito del VAR en el fútbol. En primer lugar, es bien sabido que la intención principal de la implementación del VAR en el fútbol es para poder ayudar a los árbitros centrales en toma de decisiones o, en caso de ser necesario, corregir los posibles errores humanos que pueden llegar a cometer, por ello, la primera expectativa que genera el VAR es que éste haga del fútbol un deporte más "justo" en el sentido de que los marcadores finales en cada partido reflejen exactamente, o al menos lo más parecido, todo lo sucedido dentro del partido (faltas, goles mal anulados, goles que se tengan que anular, etc.). La forma en que se pretende medir la "justicia" dentro del fútbol en esta investigación es con base en los equipos llamados "Big Six", esto debido a que siempre se tiende a pensar que estos equipos llamados los grandes de Inglaterra suelen ser favorecidos por las decisiones arbitrales en más ocasiones que aquellos equipos que no pertenecen al Big Six, por lo tanto, el primer gran resultado que esperaríamos de esta investigación sería que el VAR sancione por igual a equipos pertenecientes y no pertenecientes al Big Six, y que por lo tanto, el número neto de decisiones del VAR para con estos equipos (del Big Six) sea "consistente" con el de los demás equipos de la EPL.

Como segundo tema a tratar en esta investigación es el flujo del juego con la presencia del VAR, es decir, qué tanto ha afectado el VAR para el desarrollo del juego con base a número de goles anotados, oportunidades creadas, entre otras métricas que nos ayudan a entender el desempeño de los equipos en cada partido de la EPL. Lo importante aquí es poder medir el desempeño de los equipos en los partidos antes y después del VAR, poder saber si es posible medir un antes y después del VAR (basado en cambios muy notorios en desempeño) o si, por otro lado, el VAR simplemente funge como una herramienta opcional que no "espanta" a los equipos y por lo tanto su desempeño se mantiene a una tasa de cambio constante temporada tras temporada. Por otro lado, sabemos que el VAR es en realidad una herramienta con la cual no se "juega", en el sentido de que los jugadores dentro del campo en realidad no interactúan o no necesitan del VAR para poder llevar a cabo el desarrollo del partido, por lo tanto, el segundo gran resultado que se esperaría obtener de esta investigación es que el desempeño de los equipos de la EPL se mantiene a una tasa de cambio constante aún con la llegada del VAR (sin contar las interrupciones puntuales en que interviene el VAR para decisiones arbitrales), es decir, no hay cambios bruscos entre campañas pre y post VAR.

Estas dos hipótesis planteadas de manera general aquí se retomarán en las secciones siguientes con más detalle justo a sus respectivas justificaciones.

# 4. Descripción del análisis

Una vez explicado el propósito general de esta investigación, es importante también expicar el camino que se tomará para llevarla a cabo, esto para tener en claro el flujo de la investigación junto a sus posibles limitaciones y no incurrir en desviaciones graves que podrían alejarnos del propósito de esta investigación.

En primer lugar, se realizará un análisis exploratorio de los datos para poder conocerlos a detalle y así saber con qué tipo de datos estamos tratando en esta investigación, aquí es preciso aclarar que cuando se dice el "tipo" de datos, siempre se hace con una connotación estadística, por lo tanto, el tipo de análisis exploratorio que se realizará en la primera parte de la investigación será con la ayuda de herramientas estadísticas que nos permitan describir y, a su vez, entender el tipo de datos que se tiene sobre el fútbol de Inglaterra. Para ser un poco más precisos, en esta primera parte nos apoyaremos de medidas tradicionales en la estadística (media, mediana, cuantiles, etc.), respaldados con algunas gráficas también de índole estadística, según convenga en el desarrollo de la investigación. Una vez que se termine esta primera parte podremos ser capaces de describir a detalle los datos con los que se cuentan y, en consecuencia, podremos también saber qué rumbo debemos seguir para poder respaldar, o refutar, las hipótesis que de aquí salgan.

En segundo lugar, una vez que ya se ha realizado el análisis exploratorio y se tienen claras las primeras hipótesis de trabajo, se realizará ... **_pendiente aquí_**

# 5. Análisis exploratorio

En el punto 3 se plantearon las intenciones y expectativas generales para con esta investigación y con las cuales se pretende, a su vez, iniciar el análisis exploratorio. 

## 5.1 Un fútbol más equitativo

Como primer punto, se analizará la justicia dentro de los partidos del fútbol y cómo es que se espera que el VAR ayude con este tema en específico. Para ello, nos apoyaremos de los datos obtenidos en los artículos en línea de ESPN (puntos 2.2 y 2.3 de la sección de Datos). Como se explico en apartados anteriores, la noción de la justicia dentro del fútbol se tomará en cuenta aquí con base en los equipos llamados "Big Six", los equipos pertenecientes al big Six son los siguientes: Chelsea, Liverpool, Manchester City, Manchester United, Arsenal y Tottenham Hotspur. Por lo tanto, nuestra primer hipótesis es que el VAR trajo igualdad al fútbol y, en consecuencia, los partidos son más "parejos" y con decisiones arbitrales "centradas" para ambos equipos, es decir, no existen decisiones arbitrales cargadas a ciertos equipos (en especial para aquellos que no pertenecen al Big Six).

La primera gráfica que veremos para que nos ayude a validar o contradecir nuestra hipótesis es una gráfica de barras en donde veremos la distribución de las decisiones arbitrales basados en el tipo de equipo al que se le aplicó la sanción (Big Six vs no Big Six). En los datos que logramos recopilar acerca de las decisiones arbitrales con ayuda del VAR logramos identificar cuatro tipos de decisiones arbitrales con respecto a los equipos de la EPL, a saber, los siguientes: against (en contra), for (a favor), neutral y None (ninguno); estas categorías nos describen si la decisión que tomó el arbitro central con ayuda del VAR fue a favor, en contra o neutral con respecto al equipo en cuestión.

Para efectos de nuestro análisis no tomaremos en cuenta los tipos de decisión "neutral" y "none" debido a que ambos no aportan nada para efectos del tema a analizar, para ambos casos, el número de casos va a ser el mismo para ambos tipos de equipo (Big Six y No Big Six), y lo que queremos realmente medir es la diferencia entre ambos tipos de equipo con respecto a las decisiones tomadas con ayuda del VAR. Así mismo, tampoco se tomarán en cuenta aquellos partidos en donde ambos equipos (local y visitante) pertenezcan o no al Big Six, esto debido a que nos interesan solamente aquellos partidos en los cuales se enfrenten equipos del Big Six vs equipos no pertenecientes al Big Six, además de que si contamos casos de partidos de Big Six vs Big Six o No Big Six vs No Big Six solo inflaría los números y no nos permetiría ver en realidad la relación entre ellos.

La primera gráfica que vamos a analizar con respecto a este tema es de barras en donde podremos observar la frecuencia absoluta del tipo de decisión por parte del VAR con respecto a los tipos de equipo en la EPL (Big Six vs No Big Six).

```{r,include=FALSE}
freq_type_decisions = pl_var_inc %>% filter(bs_vs_nbs == 1 & tolower(type) %in% c('against','for')) %>% count(`tipo decision` = tolower(type), `tipo equipo` = big_six_t1, name = "decisiones")

gg1 <- ggplot(freq_type_decisions, aes(`tipo decision`,decisiones, fill = factor(`tipo equipo`))) + geom_col(position = "fill") + ggtitle('Frecuencia de decisiones del VAR por tipo de equipo (en %)') + ylab('% de decisiones tomadas') + xlab('Tipo de decision') + scale_fill_manual(values = c("#56B4E9", "#009E73")) + labs(fill = 'Tipo de equipo')
```

```{r}
print(gg1) 
```

Una vez que obtenemos la gráfica de la frecuencia absoluta (medida en \%) podemos ver que  en realidad los porcentajes para ambos tipos de equipos están muy cercanos al 50\%, es decir, ambos tipos de equipo tuvieron prácticamente el mismo número de decisiones (a favor y en contra) por parte del VAR, lo cual, a su vez, nos da una primera impresión de que el VAR si está siendo una herramienta equitativa en el fútbol. Sobre este mismo resultado, aún contando que los porcentajes para ambos tipos de equipo son prácticamente los mismos (\~50\%), podemos observar que los equipos no pertenecientes al Big Six tuvieron un total menor de decisiones en contra por parte del VAR en comparación con los equipos del Big Six, y a su vez, tuvieron un total mayor de decisiones a favor, este último resultado es uno que contradice la hipótesis inicial que insinúa cierto "favoritismo" para con los equipos del Big Six por parte del cuerpo arbitral en los partidos de la EPL.

Guiados en el resultado obtenido recientemente (en donde vimos que los equipos no pertenecientes al Big Six tuvieron más decisiones a favor por parte del VAR que aqullos equipos del Big Six), analizaremos ahora otro aspecto del desempeño del VAR en la EPL: los goles anulados y concedidos a raíz de revisiones del VAR. Este aspecto es muy importante porque, en primer lugar, los goles son la base del fútbol, es con goles que se ganan partidos al final del día y, por lo tanto, que anulen goles a los equipos puede terminar afectándolos en su intención de siempre ganar todos los partidos (al menos en primera instancia), en segundo lugar, a pesar de que vimos que el número de decisiones fue relativamente equitativo para equipos del Big Six y equipos fuera del Big Six, estas decisiones pueden ser de varias índoles y por lo tanto puede ser que las decisiones más importantes dentro de un partido (en relación a goles anotados/anulados) hayan sido marcados siempre a favor de equipos del Big Six. Así, lo que se medirá a continuación será el tipo de decisión que se tomó en un partido apoyado con el VAR.

Para esto, ya se cuenta con una tabla que cuenta el número de decisiones por tipo (goles anulados a favor, goles anulado en contra, etc.) y con ella fácilmente podemos empezar a medir este tipo de decisiones arbitrales que derivaron de la intervención del VAR, sin embargo, es preciso que primero señalemos el tipo de métrica que vamos a utilizar para empezar a medir estas variables (media, mediana, etc.), para ello, analizaremos las variables relacionadas a estas decisiones arbitrales con ciertas estadísiticas que nos ayuden a entenderlas mejor.

Las variables que nos interesan aquí son las siguientes: número de decisiones a favor (df), número de decisiones en contra (da), número de goles anulados a favor (dgf), número de goles anulados en contra (dga) y el índice de marcador neto (ngs). Con estas variables podremos tener una vista mejor de qué tanto afectó (o benefició) el VAR al marcador de los diferentes equipos de la EPL. La primera estadística que analizaremos será el nivel de asimetría (skewness por su traducción en inglés) de los datos, esta estadística nos ayudará a entender si es que nuestros datos están simétricos con respecto a la media y mediana de los mismos y con ello, posteriormente, podremos tomar la decisión de cuál es la mejor estadística (media o mediana) que nos ayude a hacer comparación entre estas variables.

```{r,include=FALSE}
skw_ot <- pl_ot %>% group_by(equipo = big_six) %>% summarise(df = skewness(df), da = skewness(da), dgf = skewness(dgf), dga = skewness(dga), ngs = skewness(ngs))

variables <- NULL
equipo <- NULL
frecuencia <- NULL
freq1 <- NULL
for(i in 1:5){
  variables <- c(variables,rep(names(skw_ot)[i+1],2))
  equipo <- c(equipo,skw_ot$equipo)
  frecuencia <- c(frecuencia,skw_ot[,i+1])
  freq1 <- c(freq1,frecuencia[[i]][1:2])
}

skw_ot_df <- data.frame(variables = variables, equipo = equipo, frecuencia = freq1)

gg2 <- ggplot(skw_ot_df,aes(variables,abs(frecuencia),fill=factor(equipo))) + geom_col(position = 'dodge') + geom_hline(yintercept = 1,linetype="dashed", color = "red") + labs(x = 'Tipo de intervención del VAR', y = 'Sesgo',fill = 'Tipo de equipo',title = 'Nivel de asimetría de los tipos de decisiones del VAR en valor absoluto') + scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

```{r}
print(gg2)
```

Después de obtener el nivel de asimetría de las variables de estudio, podemos observar que la mayoría de ellas están por debajo de 1 en valor absoluto, la única variable que sobrepasa el valor de 1 en valor absoluto es la que mide los goles anulados en contra de cada equipo no perteneciente al Big Six. Por lo tanto, salvo los goles anulados en contra para los equipos no pertenecientes al Big Six, podemos realizar las comparaciones entre estas variables y empezar a medirlas con respecto a su media, para el caso de los goles anulados en contra, la estadística que se utilizará será la mediana. 

Ya que sabemos con qué estadística vamos a hacer las comparaciones, a saber, la media, entonces estamos listos para poder realizar la siguiente gráfica que nos ayudará a entender mejor los datos acerca de las decisiones tomadas por los árbitros con la ayuda del VAR. La siguiente gráfica que utilizaremos será una de estrella o radar, esta gráfica nos ayudará a relizar comparaciones entre las variables de interés y a la vez poder tener una mejor visión del desempeño de estas variables con respecto al sujeto de estudio (el VAR), este desempeño se realizará, como en todas las gráficas hasta ahora, con base al tipo de equipo de la EPL (Big Six o No Big Six).

```{r,include=FALSE}
ot_bs <- pl_ot %>% filter(big_six == 'Big Six')
ot_nbs <- pl_ot %>% filter(big_six == 'No Big Six')

freq_ot_bs <- ot_bs %>% summarise(df = mean(df), da = mean(da), dgf = mean(dgf), dga = mean(dga), ngs = mean(ngs))
freq_ot_nbs <- ot_nbs %>% summarise(df = mean(df), da = mean(da), dgf = mean(dgf), dga = median(dga), ngs = mean(ngs))

freq_ot <- data.frame(equipo = c('Big Six','No Big Six'), df = c(freq_ot_bs$df,freq_ot_nbs$df),da = c(freq_ot_bs$da,freq_ot_nbs$da), dgf = c(freq_ot_bs$dgf,freq_ot_nbs$dgf), dga = c(freq_ot_bs$dga,freq_ot_nbs$dga), ngs = c(freq_ot_bs$ngs,freq_ot_nbs$ngs))

freq_ot <- freq_ot[,2:6]

#Calculamos los maximos y minimos de todo el data set para agregarlos a la gráfica (es necesario)
#junto con el número de variables numéricas
freq_ot_max <- freq_ot %>% max()
freq_ot_min <- freq_ot %>% min()
freq_ot_num_vars <- dim(freq_ot)[2]

freq_ot <- rbind(rep(freq_ot_max,freq_ot_num_vars) ,rep(freq_ot_min,freq_ot_num_vars),freq_ot)

#Vector de paletas de colores
areas <- c(rgb(1, 0, 0, 0.25),
           rgb(0, 1, 0, 0.25))
```

```{r}
radarchart(freq_ot,cglty = 1,cglcol = 'gray',pcol = 2:3,plwd = 2,plty = 1,pfcol = areas,title = "Radar del tipo de intervenciones del VAR")
legend('topleft',legend = c('Big Six','No Big Six'),bty = "n", pch = 20, col = areas,text.col = "grey25", pt.cex = 2,title = 'Tipo de equipo')
```

Esta gráfica de radar nos permiter ver cómo es que se comporta el VAR para con los diferentes tipos de equipos dentro de la EPL. En este caso, podemos observar que, en general, el nivel de las variables para los equipos no pertenecientes al Big Six está siempre por debajo del nivel de los equipos pertenecientes al Big Six, es decir, son menores en todo momento. De aquí podemos saltar de manera segura a conclusiones como el hecho de que, en promedio, el VAR le anula menos goles a equipos no pertenecientes al Big Six y, en cambio, el promedio de goles que anulan para beneficio de los equipos no pertenecientes al Big Six está muy cercano al promedio de los equipos del Big Six, esto nos habla de que el VAR es equitativo al menos en este rubro. 

Otra variable interesante que podemos observar aquí es la de los goles netos anotados, recordemos que esta variable mide la cantidad de goles anotados por equipo después de considerar los anulados a favor y en contra de cada equipo, por lo tanto, esta variable nos habla mucho del saldo neto que se llevan los equipos con respecto a su marcador, y por lo tanto nos habla de qué tanto se ayudan o perjudican del VAR para poder ganar partidos. Aquí podemos observar que, si bien el nivel neto de los equipos fuera del Big Six está por debajo del nivel de aquellos equipos del Big Six, éste se encuentra muy cercano al cero, lo cual nos habla que los equipos fuera del Big Six en realidad no quedan con buen saldo de goles después de la intervención del VAR (prácticamente cero) y por lo tanto es comprensible que les resulte más "difícil" poder ganar partidos. Aquí podríamos sospechar de algún tipo de "injusticia" por parte del VAR hacia con los equipos fuera del Big Six, pero, ¿el VAR es el único responsable de este nivel neto tan bajo? En posteriores análisis se tratará de respondewr a esta pregunta. 

En resumen, de esta gráfica pudimos observar que si bien todos los niveles promedio de las variables correspondientes a equipos fuera del Big Six están siempre por debajo de aquellos niveles correspondientes a equipos del Big Six, esto no siempre denota algo positivo, es más, en algunos casos resulta ser muy negativo, por ejemplo, el nivel de ngs. Basándose en los resultados obtenidos en este primer apartado podemos decir que, si bien, los niveles de intervenciones son muy parecidos entre equipos dentro y fuera del Big Six, hay algunos que, aunque la diferencia sea "mínima", el impacto a nivel de marcador dentro de los partidos puede llegar a resultar muy grande y negativo para los diferentes equipos. 

De aquí nos llevamos que el VAR no siempre es una herramienta "justa" hacia con los equipos fuera del Big Six, aunque también es cierto que esta "injusticia" se da a un nivel muy pequeño pero es algo que, en combinación con otras variables dentro del partido, puede llegar a afectar a aquellos equipos. En lo siguiente, se tratará de reforzar esta noción de "injusticia" tratando de señalar algunas otras variables que también entran en juego aquí. 

## 5.2 El VAR como ayudante "silencioso"

Como también se explicó en el punto 3 de esta investigación, una de las hipótesis que también se trata de verificar aquí es la de que el VAR se trata de una herramienta o ayudante "silencioso" en el fútbol, en el sentido de que éste solamente interviene en ocasiones realmente necesarias para el partido y que, además, no provoca que los equipos cambien drásticamente su forma de juego por tener que cuidarse todo el tiempo de aquel ojo "silencioso" del VAR que se encuentra presente en todos los ángulos de la cancha de fútbol. 

Por lo tanto, las variables que tomaremos en cuenta para este apartado son precisamente aquellas que, por su esencia, nos permiten describir el desempeño de los diferentes equipos de la EPL en cada partido. Algunos ejemplos de estas variables son los siguientes: el número de goles anotados por los equipos en cada partido, el número de goles esperados por cada equipo (xG), el número de goles esperados por posesión de cada equipo (xG), entre otros. La intención en esta parte del análisis es que estas variables nos den un panorama de cómo es que estos equipos se desarrollaron en el campo de juego una vez que el VAR entro en acción en la EPL (versus la época pre-VAR).

Una de las primeras preguntas que nos surge aquí es la de si los equipos siguen anotando el mismo número de goles aún con la presencia del VAR dentro del terreno de juego, es decir, si el número de goles al menos se mantuvo en relación a la epoca del fútbol cuando no existia el VAR. Esta pregunta parece pertinente aquí debido a que, por la existencia del VAR, los equipos pueden registrar un número inferior de goles anotados en comparación a la época pre-VAR; en primer lugar, la razón más obvia por la cual pensaríamos que se anotan menos goles en la era post-VAR es por la anulación de goles, una de las principales misiones del VAR dentro del fútbol es la revisión de cada gol que se anota en el partido para verificar su validez, por lo tanto, sería de alguna manera lógico que se registraran menos goles por partido debido a esta condición; en segundo lugar, podríamos pensar que el número total de goles anotados en un partido puede cambiar debido a los penales marcados con ayuda del VAR, en la época pre-VAR llegaba a suceder que no se marcaran algunos penales a favor de algunos equipos, los cuales, muy probablemente, podrían derivar en gol; en tercer lugar, y esto es una simple hipótesis que se está planteando en esta investigación, el número total de goles por partido podría variar debido a que los equipos pueden llegar a ser más "cautelosos" en el sentido de que no se atreven a hacer algunas jugadas o a no ir tan adelante debido a que el VAR puede detectar ciertas infracciones que el árbitro no logra ver o que juzga de manera errónea y, por lo tanto, los equipos se vuelven más reservadores.

Sobre estos tres puntos que se acaban de mencionar es que se basará el siguiente análisis de datos. En primer lugar, observaremos una gráfica de caja en donde veamos la distribución de los goles con respecto a sus cuartiles.

```{r,include=FALSE}
pl_matches <-  pl_matches %>% mutate(.,total_goles = pl_matches$score1 + pl_matches$score2)

gg3 <- ggplot(pl_matches,aes(as.factor(is_VAR),total_goles)) + geom_boxplot(fill = "#FFDB6D", color = "#C4961A") + labs(x = '¿VAR en EPL?', y = 'Número de goles',title = 'Número total de goles anotados en cada partido de la EPL antes y \n después del VAR') + scale_x_discrete(breaks = c('0','1'),labels = c('No','Si'))
```

```{r}
print(gg3)
```

Después de obtener la gráfica de caja con respecto a la era pre y pos-VAR, podemos observar que en realidad ambas cajas son prácticamente las mismas, a simple vista, parece no haber diferencia alguna entre ellas; la mediana parece estar al mismo nivel (\~3), el primer y tercer cuartil paracen estar al mismo nivel también (\~2 y \~4 respectivamente) e incluso parecen tener los mismos outliers. Por lo tanto, de esta gráfica no podemos obtener conclusiones importantes y es necesario meternos un poco a las medidas en explícito. A continuación, se mostrarán los valores de las estadísticas más importantes que se toman regularmente para medir variables de interés. 

```{r,include=FALSE}
pl_matches_no_var <- pl_matches %>% filter(.,is_VAR == 0)
pl_matches_var <- pl_matches %>% filter(.,is_VAR == 1)
sum_no_var <- summary(pl_matches_no_var$total_goles)
sum_var <- summary(pl_matches_var$total_goles)
skw_no_var <- skewness(pl_matches_no_var$total_goles)
skw_var <- skewness(pl_matches_var$total_goles)
iqr_no_var <- sum_no_var[[5]] - sum_no_var[[2]]
iqr_var <- sum_var[[5]] - sum_var[[2]]
cv_no_var <- sd(pl_matches_no_var$total_goles)/mean(pl_matches_no_var$total_goles)
cv_var <- sd(pl_matches_var$total_goles)/mean(pl_matches_var$total_goles)

estadisticas_total_goles <- c(sum_no_var[[1]],sum_no_var[[4]],sum_no_var[[3]],sum_no_var[[6]],skw_no_var,iqr_no_var,cv_no_var,
                              sum_var[[1]],sum_var[[4]],sum_var[[3]],sum_var[[6]],skw_var,iqr_var,cv_var)
nombres_est <- list(c('sin_var','con_var'),c('min','media','mediana','max','sesgo','IQR','CV'))

total_goles <- matrix(estadisticas_total_goles,nrow = 2, ncol = length(estadisticas_total_goles)/2,dimnames = nombres_est,byrow = T)
```

```{r}
total_goles
```

En esta matriz podemos obvservar algunas estadísticas que nos ayuda a describir un poco el total de goles anotados por partido cuando está presente el VAR y también cuando éste no existía en el fútbol inglés. En primera instancia podemos observar que el mínimo, la mediana, el máximo y el IQR tienen el mismo valor para ambos tipos de "fútbol" (pre y pos-VAR), por lo tanto, estas estadísticas no nos dicen nada nuevo sobre lo que ya habíamos viato previamente en la gráfica de caja; la primer variable que si cambia entre ambos tipos de fútbol es la media, para el fútbol sin presencia del VAR la media de goles anotados por partido es de `r sum_no_var[[4]]`, mientras que la media para el fútbol ya con VAR es de `r sum_var[[4]]`, aquí ya podemos observar una diferencia que, aunque pequeña (`r sum_no_var[[4]] - sum_var[[4]]`), nos permite ver que en el fútbol sin VAR se anotaban más goles en promedio por partido; la siguiente variable que varia entre un tipo de fútbol y el otro es el sesgo, esta medida que nos permite conocer si es que nuestros datos son simétricos con respecto a la media, para el fútbol sin VAR, el sesgo tiene un valor de `r skw_no_var` y para el fútbol con VAR, el sesgo tiene un valor de `r skw_var`, y aunque aquí podemos observar que el sesgo es mayor para el fútbol con VAR, en realidad ambos valores son menores a uno en valor absoluto, por lo que, al final del día podemos decir que ambos tipos de datos son simétricos y por lo tanto podemos basarnos en sus respectivas medias para posteriores mediciones y/o comparaciones; por último, tenemos el coeficiente de variación (CV), el cual también es difernte para ambos tipos de fútbol, por un lado, el CV del fútbol sin VAR tiene un valor de `r cv_no_var*100`\%. y por otro lado, el CV del fútbol con VAR tiene un valor de `r cv_var * 100 `\%, aquí, a diferencia de las demás variables, el CV del fútbol con VAR es mayor, aunque sea por muy poco (`r (cv_var - cv_no_var)*100`\%), al CV del fútbol sin VAR, de aquí podemos concluir que el número de goles anotados por partido varía mucho más en aquel fútbol donde está presente el VAR y, por lo tanto, no podríamos siempre asegurar un número estimado de goles por partido cuando el VAR se encuentra en acción a que cuando no lo está.

De este último resultado podemos asegurar que, de forma general, el fútbol con la presencia del VAR es más "impredecible", en el sentido de que los goles (y por lo tanto marcadores) varían mucho partido tras partido, y también es, a su vez, un fútbol sin tantas emociones de gol por partido.

Hasta este momento hemos podido observar que, al parecer, a grandes rasgos, el fútbol con VAR no se diferencia mucho al fútbol sin VAR en cuanto a la anotación de goles se refiere, sin embargo, hasta este momento hemos estado analizando solamente los goles efectivos anotados en cada partido, y otra de las métricas más importantes en el fútbol moderno es la esperanza de goles o "Expected Goals (xG)" por su nombre en inglés. Esta métrica nos ayudará entender las oportunidades de gol que cada equipo crea durante el partido, y esto, a su vez, nos dejará tomar un primer vistazo del desempeño de los equipos en los partidos con y sin la presencia del VAR.

A continuación, mostraremos una gráfica de caja para los goles esperados (xG) por temporada y al mismo tiempo también mostraremos una gráfica de los goles efectivos anotados por temporada para poder tener una mejor visión del desempeño de los equipos con respecto a lo que se esperaba de ellos vs lo que realmente pudieron anotar en cada partido. Aquí también se mostrará la división de los equipos por Big Six o no Big Six.

```{r,include=FALSE}
#Vamos a analizar los xG through the seasons pa ver como va cambiando con la llegada del VAR 

#Reemplazamos los Nas por ceros
pl_matches$int_var[is.na(pl_matches$int_var)] <- 0
#Sacamos el total de goles, xg y nsxg por equipo en calidad de local
performance_teams1 <- pl_matches %>% group_by(season = season2,team = team1) %>% summarise(goles_anotados1 = sum(score1), xg_acumulado1 = sum(xg1), nsxg_acumulado1 = sum(nsxg1))
#Sacamos el total de goles, xg y nsxg por equipo en calidad de visitante
performance_teams2 <- pl_matches %>% group_by(season = season2,team = team2) %>% summarise(goles_anotados2 = sum(score2), xg_acumulado2 = sum(xg2), nsxg_acumulado2 = sum(nsxg2))
#Juntamos los datos de local y visitante
performance_teams_joint <- as.data.frame(performance_teams1) %>% inner_join(as.data.frame(performance_teams2),by=c("season","team"))
#Modificamos el df para sumar los goles, xg y nsxg de local y visitante
performance_teams <- performance_teams_joint %>% mutate(.,goals_scored = goles_anotados1+goles_anotados2, total_xg = xg_acumulado1+xg_acumulado2, total_nsxg = nsxg_acumulado1+nsxg_acumulado2)
#Nos quedamos solamente con las columnas de los totales
performance_teams <- performance_teams[c(1:2,9:11)]
#Unimos la tabla recién hecha con la tabla que contiene los ovrt
performance_teams <- performance_teams %>% left_join(pl_ot,by=c('season','team'))
#Aplicamos la función big six a los equipos que no tienen la clasificación (temp < 19/20)
performance_teams$big_six <- is_big_six(performance_teams$team)
#Sustituimos los NA por ceros en todo el df
performance_teams[is.na(performance_teams)] <- 0
```

```{r,include=FALSE}
gg4 <- ggplot(performance_teams,aes(x=season,y=total_xg,fill=big_six)) + geom_boxplot() + labs(title = 'xG total por temporada en la EPL', y = 'xG', x = 'Temporada',fill='Big Six') + scale_fill_brewer(palette="Dark2")

gg5 <- ggplot(performance_teams,aes(x=season,y=goals_scored,fill=big_six)) + geom_boxplot() + labs(title = 'Total de goles anotados por partido en cada temporada de la EPL', y = 'Total de goles', x = 'Temporada', fill = 'Big Six') + scale_fill_brewer(palette = 'Dark1')
```

```{r}
grid.arrange(gg4,gg5,ncol = 1, nrow = 2,widths = 4, heights = c(4,4))
```

La primera impresión directa que nos da esta gráfica conjunta es que, para ambos casos (xG y goles efectivos anotados), las cajas de los equipos no pertenecientes al Big Six siempre están por debajo de las cajas de los equipos pertenecientes al Big Six temporada a temporada, esto quiere decir, a su vez, que siempre, en todas las temporadas, los equipos no pertenecientes al Big Six siempre creaban situaciones menos "peligrosas" (o con menos probabilidad) de gol que aquellos equipos pertencientes al Big Six, y derivado de esto, éstos mismos equipos (no pertenencientes al Big Six) anotaron en conjunto menos goles temporada a temporada. Esto puede tomarse como un resultado esperado u "obvio" debido a la historia e incluso "naturaleza propia" de la EPL. 

Ahora, un punto interesante sobre esta gráfica conjunta es que podemos observar la tendencia de los xG y goles anotados temporada a temporada y así poder ver si es que podemos identificar cierta tendencia, ya sea positiva o negativa. En este caso en particular, podemos observar que para los equipos pertenecientes al Big Six, la tendencia de los xG parece ser positiva temporada a temporada, además de que eran xG con valores altos (todos al parecer mayores a .5), esto nos dice, en primera instancia, que el VAR parece no haberles importado a estos equipos para la creación de oportunidades de gol partido a partido, sin embargo, si nos fijamos en la tendencia de los goles efectivos anotados nos damos cuenta de que al parecer ésta es negativa y con ello darnos cuenta de que, a pesar de que generan oprtunidades de gol claras ante la portería, en realidad no son capaces de culminar estas oportunidades al fondo de la red `r colorize("¿Por qué?: Pregunta a responder", "red")`. Por otro lado, si nos fijamos ahora en la tendencia de los xG y los goles efectivos anotados para los equipos fuera del Big Six podemos observar que ambas parecen ser positivas, lo cual nos indica, a su vez, que estos equipos parecen mostrar cierto tipo de mejoría conforme el paso de las temporadas al estar culminando de manera eficaz las oportunidades de gol creadas en los partidos. 

Hasta este momento, con la ayuda de las gráficas que hemos obtenido hasta este momento, podríamos decir que los equipos del Big Six presentaron una desmejora en cuanto a su actuación en los partidos de la EPL conforme el paso de la temporadas, mientras que los equipos fuera del Big Six presentaron una mejoría. Para poder tener una mejor visión de esta hipótesis analizaremos los goles netos anotados por los equipos de la EPL temporada tras temporada, estos goles netos no son más que la diferencia entre los goles efectivos anotados y los xG de cada equipo dentro de la EPL. Como hemos dicho antes, analizaremos esta tendencia de los goles netos temporada tras temporada.

En la siguiente gráfica podremos observar las líneas de tendencia de los goles netos para cada tipo de equipo en la EPL temporada tras temporada (Big Six vs No Big Six), la línea roja horizontal representa un índice de cero goles netos, el cual, a su vez, denotaría que el equipo siempre concreta todas las opciones de gol que éste crea, algo que parece sumamente difícil de lograr. Si el índice para cierta temporada se encuentra por debajo de cero quiere decir que el equipo genera más oportunidades de gol que goles efectivamente concretados, es decir, tiene una sub-actuación, por otro lado, si el índice se encuentra por arriba del cero quiere decir que el equipo concreta más goles por partido que los que genera en cuanto a propbabilidad se refiere, es decir, tiene una sobre-actuación. Lo "políticamente correcto" que se buscaría en este índice sería que todos los equipos tengan un índice de cero, con ellos, podríamos asegurar que los equipos simplemente obtienen lo que "merecen" en cuanto a desempeño dentro de los partidos se refiere, y así evitar tener casos de "suerte" en donde equipos anotan más goles que los que "merece" conforme a su desempeño, o, en caso contrario, la "mala suerte" en que los equipos anotan menos goles de los que "merecen" por su desempeño.

```{r,include=FALSE}
goles_netos <- performance_teams %>% group_by(season,big_six) %>% summarise(goles_netos = sum(goals_scored) - sum(total_xg))
goles_netos <- as.data.frame(goles_netos)
 gg6 <- ggplot(goles_netos, aes(x=season, y=goles_netos, group=big_six)) + geom_line(aes(color=big_six)) + geom_point(aes(color=big_six)) + scale_color_brewer(palette="Accent") + labs(title = 'Goles netos por temporada en la EPL', x = 'Temporada', y = 'Goles Netos', color = 'Big Six') + geom_hline(yintercept=0,color='red')
```

```{r}
print(gg6)
```

Una vez obtenida la gráfica podemos observar los siguientes resultados: Como bien habíamos predicho basados en la gráfica de caja anterior, la tendencia de los goles netos por parte de los equipos pertenecientes al Big Six va decreciendo conforme van pasando las temporadas, lo interesante aquí es que el ìndice cae por debajo del cero a partir de la temporada 19/20 lo cual coincide con la llegada del VAR de manera oficial a la EPL, ¿coincidencia? Por otro lado, la tendencia de los equipos fuera del Big Six, al contrario de lo que habíamos predicho basados en la gráfica anterior, va decreciendo también temporada tras temporada hasta que llegamos a la 19/20 en donde, sorpresivamente, tiene un repunte hasta situarse por arriba del cero, lo cual nos indica de una sobre-actuación por parte de los equipos fuera del Big Six al menos en esa temporada, ya que en la siguiente (20/21) tienen una caída muy fuerte para registrar el índice más bajo desde la 18/19. Por lo tanto, con la parte interesante que nos quedamos de este resultado es que, al parecer, la temporada 19/20 resultó ser de grandes cambios para los equipos de la EPL, por un lado, los equipos del Big Six tuvieron una caída hasta llegar por debajo del cero y, por otro lado, los equipos fuera del Big Six tuvieron un repunte de su actuación hasta llegar a niveles por arriba del cero. Con estom, resulta evidente que la temporada a analizar inmediatamente es la 19/20 para poder entonces entender este "cambio de paradigmas" entre los equipos de la EPL, ¿será que el VAR tuvo algo realmente que ver en esta temporada para poder obtener este comportamiento "atípico"?

### 5.2.1 Temporada 19/20

Los resultados obtenidos anteriormente con respecto al desempeño de los equipos de la EPL dieron paso a la intención de analizar esta temporada de manera específica ya que se sospecha que es aquí, en la primera temporada oficial del VAR dentro de la EPL, en donde los equipos tuvieron una especie de "desajuste" en cuanto a lo acostumbrado basado en temporadas anteriores.

```{r,include=FALSE}
goles <- pl_matches$int_var
goles <- goles[!is.na(goles)]
alfa <- 0.5
eps <- sqrt(1/(2*length(goles))*log(2/alfa))
plot(sort(goles), ecdf(goles)(sort(goles)), type="S",xlab = "goles",ylab = "ecdf")
abline(h = 1, lty = 2, col = "gray", lwd = 2)
#Marcamos los puntos que representan nuestros datos
rug(sort(goles), ticksize = .02, col = "blue")
#Ploteamos la cota inferior de la banda de confianza
lines(sort(goles),ecdf(goles)(sort(goles)) - eps, col = "red", type = "S")
#Ploteamos la cota superior de la banda de confianza
lines(sort(goles),ecdf(goles)(sort(goles)) + eps, col = "red", type = "S")
```

# 6. Referencias

(1) FIFA. (2017). _Video Assistant Referees (VAR)_. FIFA. https://www.fifa.com/technical/football-technology/standards/video-assistant-referee/video-assistant-referees-var

(2) Yihui Xie, Christophe Dervieux y Emily Riederer. (2021). Font Color, _R Markdown Cookbook_ (1st ed, pp. ). Chapman & Hall/CRC. https://bookdown.org/yihui/rmarkdown-cookbook/


